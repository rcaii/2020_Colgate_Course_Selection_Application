import { __read, __spread } from "tslib";
import { DateModels } from '../date/DataTypes';
import { formatDate } from '../util';
import defaultLocale from '../locale/zh_CN';
var CalendarDatePickerBaseComponent = /** @class */ (function () {
    function CalendarDatePickerBaseComponent() {
        var _this = this;
        this.props = {
            prefixCls: 'rmc-calendar',
            infinite: false,
            infiniteOpt: false,
            defaultDate: new Date(),
            initalMonths: 6,
            locale: defaultLocale
        };
        this.state = {
            months: []
        };
        this.visibleMonth = [];
        this.getDateWithoutTime = function (date) {
            if (!date) {
                return 0;
            }
            return +new Date(date.getFullYear(), date.getMonth(), date.getDate());
        };
        this.genWeekData = function (firstDate) {
            var minDateTime = _this.getDateWithoutTime(_this.props.minDate);
            var maxDateTime = _this.getDateWithoutTime(_this.props.maxDate) || Number.POSITIVE_INFINITY;
            var weeks = [];
            var nextMonth = _this.getMonthDate(firstDate, 1).firstDate;
            var currentDay = firstDate;
            var currentWeek = [];
            weeks.push(currentWeek);
            var startWeekday = currentDay.getDay();
            if (startWeekday > 0) {
                for (var i = 0; i < startWeekday; i++) {
                    currentWeek.push({});
                }
            }
            while (currentDay < nextMonth) {
                if (currentWeek.length === 7) {
                    currentWeek = [];
                    weeks.push(currentWeek);
                }
                var dayOfMonth = currentDay.getDate();
                var tick = +currentDay;
                currentWeek.push({
                    tick: tick,
                    dayOfMonth: dayOfMonth,
                    selected: DateModels.SelectType.None,
                    isFirstOfMonth: dayOfMonth === 1,
                    isLastOfMonth: false,
                    outOfDate: tick < minDateTime || tick > maxDateTime
                });
                currentDay = new Date(currentDay.getTime() + 3600 * 24 * 1000);
            }
            currentWeek[currentWeek.length - 1].isLastOfMonth = true;
            return weeks;
        };
        this.selectDateRange = function (startDate, endDate, clear) {
            if (clear === void 0) { clear = false; }
            var _a = _this.props, getDateExtra = _a.getDateExtra, type = _a.type, onSelectHasDisableDate = _a.onSelectHasDisableDate;
            if (type === 'one') {
                endDate = undefined;
            }
            var time1 = _this.getDateWithoutTime(startDate), time2 = _this.getDateWithoutTime(endDate);
            var startDateTick = !time2 || time1 < time2 ? time1 : time2;
            var endDateTick = time2 && time1 > time2 ? time1 : time2;
            var startMonthDate = _this.getMonthDate(new Date(startDateTick)).firstDate;
            var endMonthDate = endDateTick ? new Date(endDateTick) : _this.getMonthDate(new Date(startDateTick)).lastDate;
            var unuseable = [], needUpdate = false;
            _this.state.months
                .filter(function (m) {
                return m.firstDate >= startMonthDate && m.firstDate <= endMonthDate;
            })
                .forEach(function (m) {
                m.weeks.forEach(function (w) {
                    return w
                        .filter(function (d) {
                        if (!endDateTick) {
                            return d.tick && _this.inDate(startDateTick, d.tick);
                        }
                        else {
                            return d.tick && d.tick >= startDateTick && d.tick <= endDateTick;
                        }
                    })
                        .forEach(function (d) {
                        var oldValue = d.selected;
                        if (clear) {
                            d.selected = DateModels.SelectType.None;
                        }
                        else {
                            var info = (getDateExtra && getDateExtra(new Date(d.tick))) || {};
                            if (d.outOfDate || info.disable) {
                                unuseable.push(d.tick);
                            }
                            if (_this.inDate(startDateTick, d.tick)) {
                                if (type === 'one') {
                                    d.selected = DateModels.SelectType.Single;
                                }
                                else if (!endDateTick) {
                                    d.selected = DateModels.SelectType.Only;
                                }
                                else if (startDateTick !== endDateTick) {
                                    d.selected = DateModels.SelectType.Start;
                                }
                                else {
                                    d.selected = DateModels.SelectType.All;
                                }
                            }
                            else if (_this.inDate(endDateTick, d.tick)) {
                                d.selected = DateModels.SelectType.End;
                            }
                            else {
                                d.selected = DateModels.SelectType.Middle;
                            }
                        }
                        needUpdate = needUpdate || d.selected !== oldValue;
                    });
                });
                if (needUpdate && m.componentRef) {
                    m.componentRef.updateWeeks();
                }
            });
            if (unuseable.length > 0) {
                if (onSelectHasDisableDate) {
                    onSelectHasDisableDate(unuseable.map(function (tick) { return new Date(tick); }));
                }
                else {
                    console.warn('Unusable date. You can handle by onSelectHasDisableDate.', unuseable);
                }
            }
        };
        this.computeVisible = function (clientHeight, scrollTop) {
            var needUpdate = false;
            var MAX_VIEW_PORT = clientHeight * 2;
            var MIN_VIEW_PORT = clientHeight;
            // 大缓冲区外过滤规则
            var filterFunc = function (vm) {
                return vm.y &&
                    vm.height &&
                    (vm.y + vm.height > scrollTop - MAX_VIEW_PORT && vm.y < scrollTop + clientHeight + MAX_VIEW_PORT);
            };
            if (_this.props.infiniteOpt && _this.visibleMonth.length > 12) {
                _this.visibleMonth = _this.visibleMonth.filter(filterFunc).sort(function (a, b) { return +a.firstDate - +b.firstDate; });
            }
            // 当小缓冲区不满时填充
            if (_this.visibleMonth.length > 0) {
                var last = _this.visibleMonth[_this.visibleMonth.length - 1];
                if (last.y !== undefined && last.height && last.y + last.height < scrollTop + clientHeight + MIN_VIEW_PORT) {
                    var lastIndex = _this.state.months.indexOf(last);
                    for (var i = 1; i <= 2; i++) {
                        var index = lastIndex + i;
                        if (index < _this.state.months.length && _this.visibleMonth.indexOf(_this.state.months[index]) < 0) {
                            _this.visibleMonth.push(_this.state.months[index]);
                        }
                        else {
                            if (_this.canLoadNext()) {
                                _this.genMonthData(undefined, 1);
                            }
                        }
                    }
                    needUpdate = true;
                }
                var first = _this.visibleMonth[0];
                if (first.y !== undefined && first.height && first.y > scrollTop - MIN_VIEW_PORT) {
                    var firstIndex = _this.state.months.indexOf(first);
                    for (var i = 1; i <= 2; i++) {
                        var index = firstIndex - i;
                        if (index >= 0 && _this.visibleMonth.indexOf(_this.state.months[index]) < 0) {
                            _this.visibleMonth.unshift(_this.state.months[index]);
                            needUpdate = true;
                        }
                    }
                }
            }
            else if (_this.state.months.length > 0) {
                _this.visibleMonth = _this.state.months.filter(filterFunc);
                needUpdate = true;
            }
            return needUpdate;
        };
        this.createOnScroll = function () {
            // let timer: any;
            var clientHeight = 0, scrollTop = 0;
            return function (data) {
                var client = data.client, top = data.top;
                clientHeight = client;
                scrollTop = top;
                _this.computeVisible(clientHeight, scrollTop);
                // 以上方法目前无问题，如果后续有性能问题，改用如下方法，但以下方法会导致刷新稍微延迟现象
                // if (timer) {
                //   return;
                // }
                //
                // timer = setTimeout(() => {
                //   timer = undefined;
                //
                //   if (this.computeVisible(clientHeight, scrollTop)) {
                //     console.log('update dom');
                //   }
                // }, 50);
            };
        };
        this.baseOnCellClick = function (day) {
            if (!day.tick) {
                return;
            }
            if (_this.props.onCellClick) {
                _this.props.onCellClick(new Date(day.tick));
            }
        };
    }
    CalendarDatePickerBaseComponent.prototype.init = function () {
        var _a = this.props, _b = _a.initalMonths, initalMonths = _b === void 0 ? 6 : _b, defaultDate = _a.defaultDate;
        for (var i = 0; i < initalMonths; i++) {
            if (this.canLoadNext()) {
                this.genMonthData(defaultDate, i);
            }
        }
        this.visibleMonth = __spread(this.state.months);
    };
    CalendarDatePickerBaseComponent.prototype.receiveProps = function (oldValue, newValue) {
        if (oldValue && newValue) {
            if (oldValue.startDate !== newValue.startDate || oldValue.endDate !== newValue.endDate) {
                if (oldValue.startDate) {
                    this.selectDateRange(oldValue.startDate, oldValue.endDate, true);
                }
                if (newValue.startDate) {
                    this.selectDateRange(newValue.startDate, newValue.endDate);
                }
            }
        }
    };
    CalendarDatePickerBaseComponent.prototype.getMonthDate = function (date, addMonth) {
        if (date === void 0) { date = new Date(); }
        if (addMonth === void 0) { addMonth = 0; }
        var y = date.getFullYear(), m = date.getMonth();
        return {
            firstDate: new Date(y, m + addMonth, 1),
            lastDate: new Date(y, m + 1 + addMonth, 0)
        };
    };
    CalendarDatePickerBaseComponent.prototype.canLoadPrev = function () {
        var minDate = this.props.minDate;
        return (!minDate ||
            this.state.months.length <= 0 ||
            +this.getMonthDate(minDate).firstDate < +this.state.months[0].firstDate);
    };
    CalendarDatePickerBaseComponent.prototype.canLoadNext = function () {
        var maxDate = this.props.maxDate;
        return (!maxDate ||
            this.state.months.length <= 0 ||
            +this.getMonthDate(maxDate).firstDate > +this.state.months[this.state.months.length - 1].firstDate);
    };
    CalendarDatePickerBaseComponent.prototype.genMonthData = function (date, addMonth) {
        if (addMonth === void 0) { addMonth = 0; }
        if (!date) {
            date = addMonth >= 0 ? this.state.months[this.state.months.length - 1].firstDate : this.state.months[0].firstDate;
        }
        if (!date) {
            date = new Date();
        }
        var locale = this.props.locale;
        var _a = this.getMonthDate(date, addMonth), firstDate = _a.firstDate, lastDate = _a.lastDate;
        var weeks = this.genWeekData(firstDate);
        var title = formatDate(firstDate, locale ? locale.monthTitle : 'yyyy/MM', this.props.locale);
        var data = {
            title: title,
            firstDate: firstDate,
            lastDate: lastDate,
            weeks: weeks
        };
        data.component = this.genMonthComponent(data);
        if (addMonth >= 0) {
            this.state.months.push(data);
        }
        else {
            this.state.months.unshift(data);
        }
        var _b = this.props, startDate = _b.startDate, endDate = _b.endDate;
        if (startDate) {
            this.selectDateRange(startDate, endDate);
        }
        return data;
    };
    CalendarDatePickerBaseComponent.prototype.inDate = function (date, tick) {
        return date <= tick && tick < date + 24 * 3600000;
    };
    return CalendarDatePickerBaseComponent;
}());
export { CalendarDatePickerBaseComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZXBpY2tlci5iYXNlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLXpvcnJvLWFudGQtbW9iaWxlLyIsInNvdXJjZXMiOlsiY2FsZW5kYXIvZGF0ZXBpY2tlci9kYXRlcGlja2VyLmJhc2UuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNyQyxPQUFPLGFBQWEsTUFBTSxpQkFBaUIsQ0FBQztBQU01QztJQWlCRTtRQUFBLGlCQUFnQjtRQWhCaEIsVUFBSyxHQUFHO1lBQ04sU0FBUyxFQUFFLGNBQWM7WUFDekIsUUFBUSxFQUFFLEtBQUs7WUFDZixXQUFXLEVBQUUsS0FBSztZQUNsQixXQUFXLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDdkIsWUFBWSxFQUFFLENBQUM7WUFDZixNQUFNLEVBQUUsYUFBYTtTQUNDLENBQUM7UUFFekIsVUFBSyxHQUFRO1lBQ1gsTUFBTSxFQUFFLEVBQUU7U0FDWCxDQUFDO1FBRUYsaUJBQVksR0FBMkIsRUFBRSxDQUFDO1FBdUQxQyx1QkFBa0IsR0FBRyxVQUFDLElBQVc7WUFDL0IsSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDVCxPQUFPLENBQUMsQ0FBQzthQUNWO1lBQ0QsT0FBTyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDeEUsQ0FBQyxDQUFBO1FBRUQsZ0JBQVcsR0FBRyxVQUFDLFNBQWU7WUFDNUIsSUFBTSxXQUFXLEdBQUcsS0FBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDaEUsSUFBTSxXQUFXLEdBQUcsS0FBSSxDQUFDLGtCQUFr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QUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDL0YsSUFBTSxJQUFJLEdBQUc7WUFDWCxLQUFLLE9BQUE7WUFDTCxTQUFTLFdBQUE7WUFDVCxRQUFRLFVBQUE7WUFDUixLQUFLLE9BQUE7U0FDa0IsQ0FBQztRQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QyxJQUFJLFFBQVEsSUFBSSxDQUFDLEVBQUU7WUFDakIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzlCO2FBQU07WUFDTCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakM7UUFDSyxJQUFBLGVBQW1DLEVBQWpDLHdCQUFTLEVBQUUsb0JBQXNCLENBQUM7UUFDMUMsSUFBSSxTQUFTLEVBQUU7WUFDYixJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUMxQztRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELGdEQUFNLEdBQU4sVUFBTyxJQUFZLEVBQUUsSUFBWTtRQUMvQixPQUFPLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsT0FBTyxDQUFDO0lBQ3BELENBQUM7SUFnS0gsc0NBQUM7QUFBRCxDQUFDLEFBalRELElBaVRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0ZU1vZGVscyB9IGZyb20gJy4uL2RhdGUvRGF0YVR5cGVzJztcbmltcG9ydCB7IERhdGVwaWNrZXJQcm9wc1R5cGUgfSBmcm9tICcuL2RhdGVwaWNrZXIucHJvcHMuY29tcG9uZW50JztcbmltcG9ydCB7IGZvcm1hdERhdGUgfSBmcm9tICcuLi91dGlsJztcbmltcG9ydCBkZWZhdWx0TG9jYWxlIGZyb20gJy4uL2xvY2FsZS96aF9DTic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF0ZXBpY2tlclN0YXRlVHlwZSB7XG4gIG1vbnRoczogRGF0ZU1vZGVscy5Nb250aERhdGFbXTtcbn1cblxuZXhwb3J0IGNsYXNzIENhbGVuZGFyRGF0ZVBpY2tlckJhc2VDb21wb25lbnQge1xuICBwcm9wcyA9IHtcbiAgICBwcmVmaXhDbHM6ICdybWMtY2FsZW5kYXInLFxuICAgIGluZmluaXRlOiBmYWxzZSxcbiAgICBpbmZpbml0ZU9wdDogZmFsc2UsXG4gICAgZGVmYXVsdERhdGU6IG5ldyBEYXRlKCksXG4gICAgaW5pdGFsTW9udGhzOiA2LFxuICAgIGxvY2FsZTogZGVmYXVsdExvY2FsZVxuICB9IGFzIERhdGVwaWNrZXJQcm9wc1R5cGU7XG5cbiAgc3RhdGU6IGFueSA9IHtcbiAgICBtb250aHM6IFtdXG4gIH07XG5cbiAgdmlzaWJsZU1vbnRoOiBEYXRlTW9kZWxzLk1vbnRoRGF0YVtdID0gW107XG4gIGdlbk1vbnRoQ29tcG9uZW50OiAoZGF0YSkgPT4ge307XG5cbiAgY29uc3RydWN0b3IoKSB7fVxuXG4gIGluaXQoKSB7XG4gICAgY29uc3QgeyBpbml0YWxNb250aHMgPSA2LCBkZWZhdWx0RGF0ZSB9ID0gdGhpcy5wcm9wcztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluaXRhbE1vbnRoczsgaSsrKSB7XG4gICAgICBpZiAodGhpcy5jYW5Mb2FkTmV4dCgpKSB7XG4gICAgICAgIHRoaXMuZ2VuTW9udGhEYXRhKGRlZmF1bHREYXRlLCBpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy52aXNpYmxlTW9udGggPSBbLi4udGhpcy5zdGF0ZS5tb250aHNdO1xuICB9XG5cbiAgcmVjZWl2ZVByb3BzKG9sZFZhbHVlOiBEYXRlcGlja2VyUHJvcHNUeXBlLCBuZXdWYWx1ZTogRGF0ZXBpY2tlclByb3BzVHlwZSkge1xuICAgIGlmIChvbGRWYWx1ZSAmJiBuZXdWYWx1ZSkge1xuICAgICAgaWYgKG9sZFZhbHVlLnN0YXJ0RGF0ZSAhPT0gbmV3VmFsdWUuc3RhcnREYXRlIHx8IG9sZFZhbHVlLmVuZERhdGUgIT09IG5ld1ZhbHVlLmVuZERhdGUpIHtcbiAgICAgICAgaWYgKG9sZFZhbHVlLnN0YXJ0RGF0ZSkge1xuICAgICAgICAgIHRoaXMuc2VsZWN0RGF0ZVJhbmdlKG9sZFZhbHVlLnN0YXJ0RGF0ZSwgb2xkVmFsdWUuZW5kRGF0ZSwgdHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5ld1ZhbHVlLnN0YXJ0RGF0ZSkge1xuICAgICAgICAgIHRoaXMuc2VsZWN0RGF0ZVJhbmdlKG5ld1ZhbHVlLnN0YXJ0RGF0ZSwgbmV3VmFsdWUuZW5kRGF0ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBnZXRNb250aERhdGUoZGF0ZSA9IG5ldyBEYXRlKCksIGFkZE1vbnRoID0gMCkge1xuICAgIGNvbnN0IHkgPSBkYXRlLmdldEZ1bGxZZWFyKCksXG4gICAgICBtID0gZGF0ZS5nZXRNb250aCgpO1xuICAgIHJldHVybiB7XG4gICAgICBmaXJzdERhdGU6IG5ldyBEYXRlKHksIG0gKyBhZGRNb250aCwgMSksXG4gICAgICBsYXN0RGF0ZTogbmV3IERhdGUoeSwgbSArIDEgKyBhZGRNb250aCwgMClcbiAgICB9O1xuICB9XG5cbiAgY2FuTG9hZFByZXYoKSB7XG4gICAgY29uc3QgeyBtaW5EYXRlIH0gPSB0aGlzLnByb3BzO1xuICAgIHJldHVybiAoXG4gICAgICAhbWluRGF0ZSB8fFxuICAgICAgdGhpcy5zdGF0ZS5tb250aHMubGVuZ3RoIDw9IDAgfHxcbiAgICAgICt0aGlzLmdldE1vbnRoRGF0ZShtaW5EYXRlKS5maXJzdERhdGUgPCArdGhpcy5zdGF0ZS5tb250aHNbMF0uZmlyc3REYXRlXG4gICAgKTtcbiAgfVxuXG4gIGNhbkxvYWROZXh0KCkge1xuICAgIGNvbnN0IHsgbWF4RGF0ZSB9ID0gdGhpcy5wcm9wcztcbiAgICByZXR1cm4gKFxuICAgICAgIW1heERhdGUgfHxcbiAgICAgIHRoaXMuc3RhdGUubW9udGhzLmxlbmd0aCA8PSAwIHx8XG4gICAgICArdGhpcy5nZXRNb250aERhdGUobWF4RGF0ZSkuZmlyc3REYXRlID4gK3RoaXMuc3RhdGUubW9udGhzW3RoaXMuc3RhdGUubW9udGhzLmxlbmd0aCAtIDFdLmZpcnN0RGF0ZVxuICAgICk7XG4gIH1cblxuICBnZXREYXRlV2l0aG91dFRpbWUgPSAoZGF0ZT86IERhdGUpID0+IHtcbiAgICBpZiAoIWRhdGUpIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICByZXR1cm4gK25ldyBEYXRlKGRhdGUuZ2V0RnVsbFllYXIoKSwgZGF0ZS5nZXRNb250aCgpLCBkYXRlLmdldERhdGUoKSk7XG4gIH1cblxuICBnZW5XZWVrRGF0YSA9IChmaXJzdERhdGU6IERhdGUpID0+IHtcbiAgICBjb25zdCBtaW5EYXRlVGltZSA9IHRoaXMuZ2V0RGF0ZVdpdGhvdXRUaW1lKHRoaXMucHJvcHMubWluRGF0ZSk7XG4gICAgY29uc3QgbWF4RGF0ZVRpbWUgPSB0aGlzLmdldERhdGVXaXRob3V0VGltZSh0aGlzLnByb3BzLm1heERhdGUpIHx8IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTtcblxuICAgIGNvbnN0IHdlZWtzOiBEYXRlTW9kZWxzLkNlbGxEYXRhW11bXSA9IFtdO1xuICAgIGNvbnN0IG5leHRNb250aCA9IHRoaXMuZ2V0TW9udGhEYXRlKGZpcnN0RGF0ZSwgMSkuZmlyc3REYXRlO1xuICAgIGxldCBjdXJyZW50RGF5ID0gZmlyc3REYXRlO1xuICAgIGxldCBjdXJyZW50V2VlazogRGF0ZU1vZGVscy5DZWxsRGF0YVtdID0gW107XG4gICAgd2Vla3MucHVzaChjdXJyZW50V2Vlayk7XG5cbiAgICBsZXQgc3RhcnRXZWVrZGF5ID0gY3VycmVudERheS5nZXREYXkoKTtcbiAgICBpZiAoc3RhcnRXZWVrZGF5ID4gMCkge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGFydFdlZWtkYXk7IGkrKykge1xuICAgICAgICBjdXJyZW50V2Vlay5wdXNoKHt9IGFzIERhdGVNb2RlbHMuQ2VsbERhdGEpO1xuICAgICAgfVxuICAgIH1cbiAgICB3aGlsZSAoY3VycmVudERheSA8IG5leHRNb250aCkge1xuICAgICAgaWYgKGN1cnJlbnRXZWVrLmxlbmd0aCA9PT0gNykge1xuICAgICAgICBjdXJyZW50V2VlayA9IFtdO1xuICAgICAgICB3ZWVrcy5wdXNoKGN1cnJlbnRXZWVrKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGRheU9mTW9udGggPSBjdXJyZW50RGF5LmdldERhdGUoKTtcbiAgICAgIGNvbnN0IHRpY2sgPSArY3VycmVudERheTtcbiAgICAgIGN1cnJlbnRXZWVrLnB1c2goe1xuICAgICAgICB0aWNrLFxuICAgICAgICBkYXlPZk1vbnRoLFxuICAgICAgICBzZWxlY3RlZDogRGF0ZU1vZGVscy5TZWxlY3RUeXBlLk5vbmUsXG4gICAgICAgIGlzRmlyc3RPZk1vbnRoOiBkYXlPZk1vbnRoID09PSAxLFxuICAgICAgICBpc0xhc3RPZk1vbnRoOiBmYWxzZSxcbiAgICAgICAgb3V0T2ZEYXRlOiB0aWNrIDwgbWluRGF0ZVRpbWUgfHwgdGljayA+IG1heERhdGVUaW1lXG4gICAgICB9KTtcbiAgICAgIGN1cnJlbnREYXkgPSBuZXcgRGF0ZShjdXJyZW50RGF5LmdldFRpbWUoKSArIDM2MDAgKiAyNCAqIDEwMDApO1xuICAgIH1cbiAgICBjdXJyZW50V2Vla1tjdXJyZW50V2Vlay5sZW5ndGggLSAxXS5pc0xhc3RPZk1vbnRoID0gdHJ1ZTtcbiAgICByZXR1cm4gd2Vla3M7XG4gIH1cblxuICBnZW5Nb250aERhdGEoZGF0ZT86IERhdGUsIGFkZE1vbnRoOiBudW1iZXIgPSAwKSB7XG4gICAgaWYgKCFkYXRlKSB7XG4gICAgICBkYXRlID0gYWRkTW9udGggPj0gMCA/IHRoaXMuc3RhdGUubW9udGhzW3RoaXMuc3RhdGUubW9udGhzLmxlbmd0aCAtIDFdLmZpcnN0RGF0ZSA6IHRoaXMuc3RhdGUubW9udGhzWzBdLmZpcnN0RGF0ZTtcbiAgICB9XG4gICAgaWYgKCFkYXRlKSB7XG4gICAgICBkYXRlID0gbmV3IERhdGUoKTtcbiAgICB9XG4gICAgY29uc3QgeyBsb2NhbGUgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBmaXJzdERhdGUsIGxhc3REYXRlIH0gPSB0aGlzLmdldE1vbnRoRGF0ZShkYXRlLCBhZGRNb250aCk7XG4gICAgY29uc3Qgd2Vla3MgPSB0aGlzLmdlbldlZWtEYXRhKGZpcnN0RGF0ZSk7XG4gICAgY29uc3QgdGl0bGUgPSBmb3JtYXREYXRlKGZpcnN0RGF0ZSwgbG9jYWxlID8gbG9jYWxlLm1vbnRoVGl0bGUgOiAneXl5eS9NTScsIHRoaXMucHJvcHMubG9jYWxlKTtcbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgdGl0bGUsXG4gICAgICBmaXJzdERhdGUsXG4gICAgICBsYXN0RGF0ZSxcbiAgICAgIHdlZWtzXG4gICAgfSBhcyBEYXRlTW9kZWxzLk1vbnRoRGF0YTtcbiAgICBkYXRhLmNvbXBvbmVudCA9IHRoaXMuZ2VuTW9udGhDb21wb25lbnQoZGF0YSk7XG4gICAgaWYgKGFkZE1vbnRoID49IDApIHtcbiAgICAgIHRoaXMuc3RhdGUubW9udGhzLnB1c2goZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3RhdGUubW9udGhzLnVuc2hpZnQoZGF0YSk7XG4gICAgfVxuICAgIGNvbnN0IHsgc3RhcnREYXRlLCBlbmREYXRlIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChzdGFydERhdGUpIHtcbiAgICAgIHRoaXMuc2VsZWN0RGF0ZVJhbmdlKHN0YXJ0RGF0ZSwgZW5kRGF0ZSk7XG4gICAgfVxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgaW5EYXRlKGRhdGU6IG51bWJlciwgdGljazogbnVtYmVyKSB7XG4gICAgcmV0dXJuIGRhdGUgPD0gdGljayAmJiB0aWNrIDwgZGF0ZSArIDI0ICogMzYwMDAwMDtcbiAgfVxuXG4gIHNlbGVjdERhdGVSYW5nZSA9IChzdGFydERhdGU6IERhdGUsIGVuZERhdGU/OiBEYXRlLCBjbGVhciA9IGZhbHNlKSA9PiB7XG4gICAgY29uc3QgeyBnZXREYXRlRXh0cmEsIHR5cGUsIG9uU2VsZWN0SGFzRGlzYWJsZURhdGUgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKHR5cGUgPT09ICdvbmUnKSB7XG4gICAgICBlbmREYXRlID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdCB0aW1lMSA9IHRoaXMuZ2V0RGF0ZVdpdGhvdXRUaW1lKHN0YXJ0RGF0ZSksXG4gICAgICB0aW1lMiA9IHRoaXMuZ2V0RGF0ZVdpdGhvdXRUaW1lKGVuZERhdGUpO1xuICAgIGNvbnN0IHN0YXJ0RGF0ZVRpY2sgPSAhdGltZTIgfHwgdGltZTEgPCB0aW1lMiA/IHRpbWUxIDogdGltZTI7XG4gICAgY29uc3QgZW5kRGF0ZVRpY2sgPSB0aW1lMiAmJiB0aW1lMSA+IHRpbWUyID8gdGltZTEgOiB0aW1lMjtcblxuICAgIGNvbnN0IHN0YXJ0TW9udGhEYXRlID0gdGhpcy5nZXRNb250aERhdGUobmV3IERhdGUoc3RhcnREYXRlVGljaykpLmZpcnN0RGF0ZTtcbiAgICBjb25zdCBlbmRNb250aERhdGUgPSBlbmREYXRlVGljayA/IG5ldyBEYXRlKGVuZERhdGVUaWNrKSA6IHRoaXMuZ2V0TW9udGhEYXRlKG5ldyBEYXRlKHN0YXJ0RGF0ZVRpY2spKS5sYXN0RGF0ZTtcblxuICAgIGxldCB1bnVzZWFibGU6IG51bWJlcltdID0gW10sXG4gICAgICBuZWVkVXBkYXRlID0gZmFsc2U7XG4gICAgdGhpcy5zdGF0ZS5tb250aHNcbiAgICAgIC5maWx0ZXIobSA9PiB7XG4gICAgICAgIHJldHVybiBtLmZpcnN0RGF0ZSA+PSBzdGFydE1vbnRoRGF0ZSAmJiBtLmZpcnN0RGF0ZSA8PSBlbmRNb250aERhdGU7XG4gICAgICB9KVxuICAgICAgLmZvckVhY2gobSA9PiB7XG4gICAgICAgIG0ud2Vla3MuZm9yRWFjaCh3ID0+XG4gICAgICAgICAgd1xuICAgICAgICAgICAgLmZpbHRlcihkID0+IHtcbiAgICAgICAgICAgICAgaWYgKCFlbmREYXRlVGljaykge1xuICAgICAgICAgICAgICAgIHJldHVybiBkLnRpY2sgJiYgdGhpcy5pbkRhdGUoc3RhcnREYXRlVGljaywgZC50aWNrKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZC50aWNrICYmIGQudGljayA+PSBzdGFydERhdGVUaWNrICYmIGQudGljayA8PSBlbmREYXRlVGljaztcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5mb3JFYWNoKGQgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IGQuc2VsZWN0ZWQ7XG4gICAgICAgICAgICAgIGlmIChjbGVhcikge1xuICAgICAgICAgICAgICAgIGQuc2VsZWN0ZWQgPSBEYXRlTW9kZWxzLlNlbGVjdFR5cGUuTm9uZTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gKGdldERhdGVFeHRyYSAmJiBnZXREYXRlRXh0cmEobmV3IERhdGUoZC50aWNrKSkpIHx8IHt9O1xuICAgICAgICAgICAgICAgIGlmIChkLm91dE9mRGF0ZSB8fCBpbmZvLmRpc2FibGUpIHtcbiAgICAgICAgICAgICAgICAgIHVudXNlYWJsZS5wdXNoKGQudGljayk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmluRGF0ZShzdGFydERhdGVUaWNrLCBkLnRpY2spKSB7XG4gICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ29uZScpIHtcbiAgICAgICAgICAgICAgICAgICAgZC5zZWxlY3RlZCA9IERhdGVNb2RlbHMuU2VsZWN0VHlwZS5TaW5nbGU7XG4gICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFlbmREYXRlVGljaykge1xuICAgICAgICAgICAgICAgICAgICBkLnNlbGVjdGVkID0gRGF0ZU1vZGVscy5TZWxlY3RUeXBlLk9ubHk7XG4gICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0RGF0ZVRpY2sgIT09IGVuZERhdGVUaWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIGQuc2VsZWN0ZWQgPSBEYXRlTW9kZWxzLlNlbGVjdFR5cGUuU3RhcnQ7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBkLnNlbGVjdGVkID0gRGF0ZU1vZGVscy5TZWxlY3RUeXBlLkFsbDtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5EYXRlKGVuZERhdGVUaWNrLCBkLnRpY2spKSB7XG4gICAgICAgICAgICAgICAgICBkLnNlbGVjdGVkID0gRGF0ZU1vZGVscy5TZWxlY3RUeXBlLkVuZDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgZC5zZWxlY3RlZCA9IERhdGVNb2RlbHMuU2VsZWN0VHlwZS5NaWRkbGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIG5lZWRVcGRhdGUgPSBuZWVkVXBkYXRlIHx8IGQuc2VsZWN0ZWQgIT09IG9sZFZhbHVlO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKG5lZWRVcGRhdGUgJiYgbS5jb21wb25lbnRSZWYpIHtcbiAgICAgICAgICBtLmNvbXBvbmVudFJlZi51cGRhdGVXZWVrcygpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICBpZiAodW51c2VhYmxlLmxlbmd0aCA+IDApIHtcbiAgICAgIGlmIChvblNlbGVjdEhhc0Rpc2FibGVEYXRlKSB7XG4gICAgICAgIG9uU2VsZWN0SGFzRGlzYWJsZURhdGUodW51c2VhYmxlLm1hcCh0aWNrID0+IG5ldyBEYXRlKHRpY2spKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLndhcm4oJ1VudXNhYmxlIGRhdGUuIFlvdSBjYW4gaGFuZGxlIGJ5IG9uU2VsZWN0SGFzRGlzYWJsZURhdGUuJywgdW51c2VhYmxlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb21wdXRlVmlzaWJsZSA9IChjbGllbnRIZWlnaHQ6IG51bWJlciwgc2Nyb2xsVG9wOiBudW1iZXIpID0+IHtcbiAgICBsZXQgbmVlZFVwZGF0ZSA9IGZhbHNlO1xuICAgIGNvbnN0IE1BWF9WSUVXX1BPUlQgPSBjbGllbnRIZWlnaHQgKiAyO1xuICAgIGNvbnN0IE1JTl9WSUVXX1BPUlQgPSBjbGllbnRIZWlnaHQ7XG5cbiAgICAvLyDlpKfnvJPlhrLljLrlpJbov4fmu6Top4TliJlcbiAgICBjb25zdCBmaWx0ZXJGdW5jID0gKHZtOiBEYXRlTW9kZWxzLk1vbnRoRGF0YSkgPT5cbiAgICAgIHZtLnkgJiZcbiAgICAgIHZtLmhlaWdodCAmJlxuICAgICAgKHZtLnkgKyB2bS5oZWlnaHQgPiBzY3JvbGxUb3AgLSBNQVhfVklFV19QT1JUICYmIHZtLnkgPCBzY3JvbGxUb3AgKyBjbGllbnRIZWlnaHQgKyBNQVhfVklFV19QT1JUKTtcblxuICAgIGlmICh0aGlzLnByb3BzLmluZmluaXRlT3B0ICYmIHRoaXMudmlzaWJsZU1vbnRoLmxlbmd0aCA+IDEyKSB7XG4gICAgICB0aGlzLnZpc2libGVNb250aCA9IHRoaXMudmlzaWJsZU1vbnRoLmZpbHRlcihmaWx0ZXJGdW5jKS5zb3J0KChhLCBiKSA9PiArYS5maXJzdERhdGUgLSArYi5maXJzdERhdGUpO1xuICAgIH1cblxuICAgIC8vIOW9k+Wwj+e8k+WGsuWMuuS4jea7oeaXtuWhq+WFhVxuICAgIGlmICh0aGlzLnZpc2libGVNb250aC5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBsYXN0ID0gdGhpcy52aXNpYmxlTW9udGhbdGhpcy52aXNpYmxlTW9udGgubGVuZ3RoIC0gMV07XG4gICAgICBpZiAobGFzdC55ICE9PSB1bmRlZmluZWQgJiYgbGFzdC5oZWlnaHQgJiYgbGFzdC55ICsgbGFzdC5oZWlnaHQgPCBzY3JvbGxUb3AgKyBjbGllbnRIZWlnaHQgKyBNSU5fVklFV19QT1JUKSB7XG4gICAgICAgIGNvbnN0IGxhc3RJbmRleCA9IHRoaXMuc3RhdGUubW9udGhzLmluZGV4T2YobGFzdCk7XG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IDI7IGkrKykge1xuICAgICAgICAgIGNvbnN0IGluZGV4ID0gbGFzdEluZGV4ICsgaTtcbiAgICAgICAgICBpZiAoaW5kZXggPCB0aGlzLnN0YXRlLm1vbnRocy5sZW5ndGggJiYgdGhpcy52aXNpYmxlTW9udGguaW5kZXhPZih0aGlzLnN0YXRlLm1vbnRoc1tpbmRleF0pIDwgMCkge1xuICAgICAgICAgICAgdGhpcy52aXNpYmxlTW9udGgucHVzaCh0aGlzLnN0YXRlLm1vbnRoc1tpbmRleF0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jYW5Mb2FkTmV4dCgpKSB7XG4gICAgICAgICAgICAgIHRoaXMuZ2VuTW9udGhEYXRhKHVuZGVmaW5lZCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG5lZWRVcGRhdGUgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmaXJzdCA9IHRoaXMudmlzaWJsZU1vbnRoWzBdO1xuICAgICAgaWYgKGZpcnN0LnkgIT09IHVuZGVmaW5lZCAmJiBmaXJzdC5oZWlnaHQgJiYgZmlyc3QueSA+IHNjcm9sbFRvcCAtIE1JTl9WSUVXX1BPUlQpIHtcbiAgICAgICAgY29uc3QgZmlyc3RJbmRleCA9IHRoaXMuc3RhdGUubW9udGhzLmluZGV4T2YoZmlyc3QpO1xuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSAyOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBpbmRleCA9IGZpcnN0SW5kZXggLSBpO1xuICAgICAgICAgIGlmIChpbmRleCA+PSAwICYmIHRoaXMudmlzaWJsZU1vbnRoLmluZGV4T2YodGhpcy5zdGF0ZS5tb250aHNbaW5kZXhdKSA8IDApIHtcbiAgICAgICAgICAgIHRoaXMudmlzaWJsZU1vbnRoLnVuc2hpZnQodGhpcy5zdGF0ZS5tb250aHNbaW5kZXhdKTtcbiAgICAgICAgICAgIG5lZWRVcGRhdGUgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5tb250aHMubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy52aXNpYmxlTW9udGggPSB0aGlzLnN0YXRlLm1vbnRocy5maWx0ZXIoZmlsdGVyRnVuYyk7XG4gICAgICBuZWVkVXBkYXRlID0gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmVlZFVwZGF0ZTtcbiAgfVxuXG4gIGNyZWF0ZU9uU2Nyb2xsID0gKCkgPT4ge1xuICAgIC8vIGxldCB0aW1lcjogYW55O1xuICAgIGxldCBjbGllbnRIZWlnaHQgPSAwLFxuICAgICAgc2Nyb2xsVG9wID0gMDtcblxuICAgIHJldHVybiAoZGF0YTogeyBmdWxsOiBudW1iZXI7IGNsaWVudDogbnVtYmVyOyB0b3A6IG51bWJlciB9KSA9PiB7XG4gICAgICBjb25zdCB7IGNsaWVudCwgdG9wIH0gPSBkYXRhO1xuICAgICAgY2xpZW50SGVpZ2h0ID0gY2xpZW50O1xuICAgICAgc2Nyb2xsVG9wID0gdG9wO1xuXG4gICAgICB0aGlzLmNvbXB1dGVWaXNpYmxlKGNsaWVudEhlaWdodCwgc2Nyb2xsVG9wKTtcblxuICAgICAgLy8g5Lul5LiK5pa55rOV55uu5YmN5peg6Zeu6aKY77yM5aaC5p6c5ZCO57ut5pyJ5oCn6IO96Zeu6aKY77yM5pS555So5aaC5LiL5pa55rOV77yM5L2G5Lul5LiL5pa55rOV5Lya5a+86Ie05Yi35paw56iN5b6u5bu26L+f546w6LGhXG5cbiAgICAgIC8vIGlmICh0aW1lcikge1xuICAgICAgLy8gICByZXR1cm47XG4gICAgICAvLyB9XG4gICAgICAvL1xuICAgICAgLy8gdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIC8vICAgdGltZXIgPSB1bmRlZmluZWQ7XG4gICAgICAvL1xuICAgICAgLy8gICBpZiAodGhpcy5jb21wdXRlVmlzaWJsZShjbGllbnRIZWlnaHQsIHNjcm9sbFRvcCkpIHtcbiAgICAgIC8vICAgICBjb25zb2xlLmxvZygndXBkYXRlIGRvbScpO1xuICAgICAgLy8gICB9XG4gICAgICAvLyB9LCA1MCk7XG4gICAgfTtcbiAgfVxuXG4gIGJhc2VPbkNlbGxDbGljayA9IChkYXk6IERhdGVNb2RlbHMuQ2VsbERhdGEpID0+IHtcbiAgICBpZiAoIWRheS50aWNrKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLnByb3BzLm9uQ2VsbENsaWNrKSB7XG4gICAgICB0aGlzLnByb3BzLm9uQ2VsbENsaWNrKG5ldyBEYXRlKGRheS50aWNrKSk7XG4gICAgfVxuICB9XG59XG4iXX0=